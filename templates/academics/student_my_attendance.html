{% extends "base.html" %}
{% load static %}

{% block page_title %}My Attendance{% endblock page_title %}
{% block main_page_title %}My Attendance{% endblock main_page_title %}

{% block content %}
    <div class="row">
        {# Semester Filter Card #}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <form method="get" action="" class="form-inline">
                        <div class="form-group mr-3">
                            <label for="semesterFilter" class="mr-2"><strong>View Semester</strong></label>
                            <select id="semesterFilter" name="semester" class="form-control custom-select" onchange="this.form.submit()">
                                {% for sem in available_semesters %}
                                    <option value="{{ sem }}" {% if sem == selected_semester %}selected{% endif %}>
                                        Semester {{ sem }}
                                    </option>
                                {% empty %}
                                     <option>No Semesters Found</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Overall Attendance Chart #}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        Overall Attendance (Semester {{ selected_semester|default:'N/A' }})
                    </h5>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="overallDoughnutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Subject-wise Attendance Charts #}
    <div class="row">
        {% for item in subject_attendance_data %}
            <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ item.subject_name }}</h5>
                         <p class="text-muted text-small mb-2">Total Classes: {{ item.total_classes }}</p>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="doughnutChart{{ item.subject_pk }}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-info">No attendance data available for this semester.</div>
            </div>
        {% endfor %}
    </div>
{% endblock content %}

{% block page_scripts %}
    <script src="{% static 'js/vendor/Chart.bundle.min.js' %}"></script>
    <script src="{% static 'js/vendor/chartjs-plugin-datalabels.js' %}"></script>
    <script>
        $(document).ready(function () {
            // --- Global Chart Config ---
            var rootStyle = getComputedStyle(document.body);
            var primaryColor = rootStyle.getPropertyValue("--primary-color").trim();
            var foregroundColor = rootStyle.getPropertyValue("--foreground-color").trim();
            var separatorColor = rootStyle.getPropertyValue("--separator-color").trim();
            var chartTooltip = {backgroundColor: foregroundColor, titleFontColor: primaryColor, borderColor: separatorColor, borderWidth: 0.5, bodyFontColor: primaryColor, bodySpacing: 10, xPadding: 15, yPadding: 15, cornerRadius: 0.15, displayColors: false };

            if (typeof Chart !== "undefined") {
                Chart.defaults.global.defaultFontFamily = "'JetBrains Mono', sans-serif";
                Chart.defaults.DoughnutWithShadow = Chart.defaults.doughnut;
                Chart.controllers.DoughnutWithShadow = Chart.controllers.doughnut.extend({
                    draw: function (ease) {
                        Chart.controllers.doughnut.prototype.draw.call(this, ease);
                        let ctx = this.chart.chart.ctx;
                        ctx.save();
                        ctx.shadowColor = "rgba(0,0,0,0.15)";
                        ctx.shadowBlur = 10;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 10;
                        ctx.responsive = true;
                        Chart.controllers.doughnut.prototype.draw.apply(this, arguments);
                        ctx.restore();
                    }
                });
            }

            // --- Center Text Plugin (Modified to accept a pre-calculated percentage) ---
            var centerTextPlugin = {
                beforeDraw: function (chart) {
                    var width = chart.chartArea.right;
                    var height = chart.chartArea.bottom;
                    var ctx = chart.chart.ctx;
                    ctx.restore();

                    // Get the official percentage from the chart's custom options
                    var officialPercentage = chart.options.centerText ? chart.options.centerText.percentage : 0;

                    ctx.font = "36px" + " Nunito, sans-serif";
                    ctx.fillStyle = primaryColor;
                    ctx.textBaseline = "middle";

                    var text = officialPercentage.toFixed(1) + "%",
                        textX = Math.round((width - ctx.measureText(text).width) / 2),
                        textY = height / 2;

                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            };


            // --- Reusable Chart Initialization Function ---
            function initializeChart(canvasId, presentCount, absentCount, onDutyCount, officialPercentage) {
                const ctx = document.getElementById(canvasId)?.getContext('2d');
                if (!ctx) return; // Don't try to render if canvas not found

                const total = presentCount + absentCount + onDutyCount;

                let labels = ['Present', 'Absent', 'On Duty'];
                let data = [presentCount, absentCount, onDutyCount];
                let backgroundColors = ["rgba(40, 212, 69, 0.2)", "rgba(250, 4, 27, 0.2)", "rgba(150, 150, 150, 0.2)"];
                let borderColors = ["rgba(40, 212, 69, 0.75)", "rgba(250, 4, 27, 0.75)", "rgba(150, 150, 150, 0.75)"];

                if (total === 0) {
                    labels = ['No Data'];
                    data = [1];
                    backgroundColors = ["rgba(150, 150, 150, 0.2)"];
                    borderColors = ["rgba(150, 150, 150, 0.75)"];
                }

                new Chart(ctx, {
                    type: 'DoughnutWithShadow',
                    data: {
                        labels: labels,
                        datasets: [{ data: data, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 2 }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutoutPercentage: 80,
                        title: { display: false },
                        centerText: { percentage: officialPercentage, color: primaryColor }, // Pass data to our plugin
                        legend: {
                            display: true, position: 'bottom', labels: { padding: 20, usePointStyle: true, fontSize: 12,
                                generateLabels: function (chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => ({
                                        text: `${label} - ${data.datasets[0].data[i]}`,
                                        fillStyle: data.datasets[0].backgroundColor[i]
                                    }));
                                }
                            }
                        },
                        plugins: { datalabels: { display: false } },
                        tooltips: chartTooltip
                    },
                    plugins: [centerTextPlugin]
                });
            }

            // --- Initialize All Charts ---

            // 1. Overall Chart
            initializeChart(
                'overallDoughnutChart',
                {{ overall_attended }},
                {{ overall_absent }},
                {{ overall_on_duty }},
                {{ overall_official_percentage }}
            );

            // 2. Individual Subject Charts
            const subjectAttendanceData = JSON.parse('{{ subject_attendance_data_json|safe }}');
            subjectAttendanceData.forEach(item => {
                initializeChart(
                    `doughnutChart${item.subject_pk}`,
                    item.attended_classes,
                    item.absent_classes,
                    item.on_duty_classes,
                    item.official_percentage
                );
            });
        });
    </script>
{% endblock page_scripts %}