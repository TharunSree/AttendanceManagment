{% extends "base.html" %}
{% load nav_helpers %}

{% block page_title %}Manage Timetable{% endblock page_title %}
{% block main_page_title %}Manage Timetable{% endblock main_page_title %}

{% block page_styles %}
    <style>
        .modal-backdrop.show {
            backdrop-filter: blur(22px);
        -webkit-backdrop-filter: blur(22px);
        background-color: rgba(0, 0, 0, 0.3);
        }

        .timetable-cell {
            cursor: pointer;
            min-width: 150px;
        }

        .timetable-cell:empty::after {
            content: "+ Add";
            color: #8f8f8f;
            font-style: italic;
        }

        .timetable-entry {
            border-radius: 5px;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.1);
        }
    </style>
{% endblock page_styles %}

{% block content %}

    <div class="modal fade" id="timetable-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <form id="timetable-entry-form" method="post" novalidate>
                <div class="modal-content">
                    {# Content will be loaded here via AJAX #}
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Select a Class to Manage</h5>
                    <form method="get" id="group-select-form">
                        <div class="form-group">
                            <select class="form-control select2-single" name="group_id" onchange="this.form.submit()">
                                <option value="">-- Select a Class --</option>
                                {% for group in student_groups %}
                                    <option value="{{ group.pk }}"
                                            {% if selected_group.pk == group.pk %}selected{% endif %}>
                                        {{ group.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            {% if selected_group %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Timetable for {{ selected_group.name }}</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered text-center" id="timetable-grid">
                                <thead>
                                <tr>
                                    <th>Time</th>
                                    {% for day in days_of_week %}
                                        <th>{{ day }}</th>
                                    {% endfor %}
                                </tr>
                                </thead>
                                <tbody>
                                {% for slot in timeslots %}
                                    <tr>
                                        <td class="{% if not slot.is_schedulable %}text-muted{% endif %}">{{ slot }}</td>
                                        {% if slot.is_schedulable %}
                                            {% for day in days_of_week %}
                                                <td class="timetable-cell"
                                                    data-day="{{ day }}"
                                                    data-slot-id="{{ slot.id }}"
                                                    data-create-url="{% url 'academics:timetable_entry_create' selected_group.pk day slot.id %}">

                                                    {% with entry=timetable_grid|get_item:day|get_item:slot.id %}
                                                        {% if entry %}
                                                            <div class="timetable-entry"
                                                                 data-update-url="{% url 'academics:timetable_entry_update' entry.pk %}"
                                                                 data-delete-url="{% url 'academics:timetable_entry_delete' entry.pk %}">

                                                                <strong>{{ entry.subject.subject.name }}</strong>
                                                                <p class="text-muted mb-0 text-small">{{ entry.faculty.get_full_name }}</p>
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                            {% endfor %}
                                        {% else %}
                                            <td colspan="{{ days_of_week|length|add:1 }}"
                                                class="font-weight-bold text-muted" style="font-size: 22px;">
                                                {{ slot.label|upper }}
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock content %}

{% block page_scripts %}
    <script>
        $(document).ready(function () {
            console.log("DEBUG: Timetable script loaded. Document is ready.");

            const modal = $('#timetable-modal');
            if (modal.length === 0) {
                console.error("DEBUG ERROR: Modal with ID #timetable-modal was not found in the HTML.");
                return;
            }
            const modalContent = modal.find('.modal-content');
            const form = modal.find('#timetable-entry-form');

            // --- Click handler for any schedulable cell ---
            $('#timetable-grid').on('click', '.timetable-cell', function () {
                console.log("DEBUG: Timetable cell clicked.");

                let currentCell = $(this);
                const entry = currentCell.find('.timetable-entry');
                let url;

                if (entry.length > 0) { // Check if we are editing an existing entry
                    url = entry.data('update-url');
                    console.log("DEBUG: Edit mode detected. URL: " + url);
                } else { // Or adding a new one
                    url = currentCell.data('create-url');
                    console.log("DEBUG: Add mode detected. URL: " + url);
                }

                if (!url) {
                    console.error("DEBUG ERROR: Could not find a URL in the cell's data attributes.");
                    return;
                }

                // Fetch the form from the server via AJAX
                console.log("DEBUG: Making GET request to: " + url);
                $.get(url, function (data) {
                    console.log("DEBUG: AJAX request successful. Received form HTML.");
                    modalContent.html(data);

                    console.log("DEBUG: Initializing select2 dropdowns...");
                    modal.find('.select2-single').select({theme: "bootstrap", placeholder: ""});

                    if (entry.length > 0) {
                        $('#btn-delete-entry').data('delete-url', entry.data('delete-url')).removeClass('d-none');
                    }

                    console.log("DEBUG: Showing modal.");
                    modal.modal('show');
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("DEBUG ERROR: AJAX GET request failed!");
                    console.error("Status: " + textStatus);
                    console.error("Error: " + errorThrown);
                    console.error("Response: " + jqXHR.responseText);
                });
            });

            // --- Handler for form submission inside the modal ---
            form.on('submit', function (e) {
                e.preventDefault();
                console.log("DEBUG: Modal form submitted.");
                $.post(form.attr('action'), form.serialize(), function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("Please correct the errors in the form.");
                    }
                }).fail(() => alert("An error occurred submitting the form."));
            });

            // --- Handler for the delete button inside the modal ---
            modal.on('click', '#btn-delete-entry', function () {
                if (!confirm('Are you sure you want to delete this period?')) return;
                console.log("DEBUG: Delete button clicked.");
                const url = $(this).data('delete-url');
                const csrfToken = '{{ csrf_token }}';

                $.post(url, {'csrfmiddlewaretoken': csrfToken}, function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || "Could not delete.");
                    }
                }).fail(() => alert("An error occurred during deletion."));
            });
        });
    </script>
{% endblock page_scripts %}
